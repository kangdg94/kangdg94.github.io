# [Monitoring] ELK

## 1. ELK ë€?

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled.png)

**ELK**ëŠ” ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´, ë¶„ì„ ë° ì €ì¥ ê¸°ëŠ¥ì„ ë‹´ë‹¹í•˜ëŠ”Â **ElasticSearch**, ìˆ˜ì§‘ ê¸°ëŠ¥ì„ í•˜ëŠ”Â **Logstash**, ì´ë¥¼ ì‹œê°í™” í•˜ëŠ” ë„êµ¬ì¸Â **Kibana**ì˜ ì• ê¸€ìë§Œ ë”´ ë‹¨ì–´ì´ë‹¤. ë¨¼ì € Prometheusë¥¼ ì‚¬ìš© í•˜ì˜€ìœ¼ë‚˜, prometheusëŠ” ì„œë¹„ìŠ¤ ë¡œê·¸ë“¤ì„ ìˆ˜ì§‘ í•˜ê¸° ì–´ë ¤ìš°ë©° pollingë°©ì‹ì´ë¼ ê° ì„œë¹„ìŠ¤ë“¤ì´ prometheusì— ë°ì´í„°ë¥¼ ì „ì†¡ í•´ì£¼ëŠ” í˜•íƒœë¡œ, ì„œë¹„ìŠ¤ë“¤ ì½”ë“œì— ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤. ì´ëŠ” ì„œë¹„ìŠ¤ ìš´ì˜ì— ëŒ€í•œ ë¦¬ìŠ¤í¬ê°€ ì¡´ì¬í•˜ë©°, í¬íŠ¸ ì¶©ëŒë„ ìš°ë ¤ê°€ ë˜ì–´ ELK ë„ì…ì„ í•˜ê²Œ ë˜ì—ˆë‹¤.

**1) ElasticSearch**

- í¬ê²Œ Aggregation ê³¼ Query ë‘ ê¸°ëŠ¥ìœ¼ë¡œ ë‚˜ë‰˜ë©°, QueryëŠ” í˜• ë¶„ì„ Aggregationì€ ì§‘ê³„, ì¦‰ ëª¨ë‹ˆí„°ë§ ìª½ì—ì„œ ë§ì´ ì“°ì¸ë‹¤. ì´ˆê¸°ì—ëŠ” Queryë¡œ ë“±ì¥í•˜ì˜€ìœ¼ë‚˜ ìµœê·¼ì—ëŠ” Aggregation ê¸°ëŠ¥ìœ¼ë¡œ ë§ì´ ì‚¬ìš©ë˜ê³  ìˆëŠ” ê²ƒìœ¼ë¡œ ë³´ì„
- ë¡œê·¸, ì •í˜•, ë¹„ì •í˜•, ìœ„ì¹˜ì •ë³´, ë©”íŠ¸ë¦­ ë“± ì›í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ë‹¤ì–‘í•œ ìœ í˜•ì˜ ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ê³  ê²°í•©í•  ìˆ˜ ìˆë‹¤.

**2) Logstash**

- ë°ì´í„° ì²˜ë¦¬ íŒŒì´í”„ ë¼ì¸ìœ¼ë¡œ, ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ë™ì‹œì— ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ë³€í™˜í•˜ì—¬ stash ë³´ê´€ì†Œë¡œ ë³´ë‚¸ë‹¤.
- ìˆ˜ì§‘í•  ë¡œê·¸ë¥¼ ì„ ì •í•´ì„œ, ì§€ì •ëœ ëŒ€ìƒ ì„œë²„(ElasticSearch)ì— ì¸ë±ì‹±í•˜ì—¬ ì „ì†¡í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•˜ëŠ” ì„œë¹„ìŠ¤ë‹¤.

**3) Kibana**

- ë°ì´í„°ë¥¼ ì‹œê°ì ìœ¼ë¡œ íƒìƒ‰í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„ í•  ìˆ˜ ìˆë‹¤.
- ì‹œê°í™”ë¥¼ ë‹´ë‹¹í•˜ëŠ” HTML + Javascript ì—”ì§„ì´ë¼ê³  ë³´ë©´ ëœë‹¤.

## 2. Beats ë€?

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled%201.png)

**Beats :**Â ì„œë²„ì— ì—ì´ì „íŠ¸ë¡œ ì„¤ì¹˜í•˜ì—¬ ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë°ì´í„°ë¥¼ ElasticSearch ë˜ëŠ” Logstashì— ì „ì†¡í•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ë°ì´í„° ë°œì†¡ìë‹¤.

- ELK ì†”ë£¨ì…˜ì—ì„œ Beats ì¶”ê°€ë˜ë©´ì„œ ELK Stackì´ë¼ê³  ë¶ˆë¦°ë‹¤.
- í¬ê²Œ ì„œë¹„ìŠ¤ ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•  filebeatì™€ ì„œë²„ ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ìˆ˜ì§‘í•  metricbeatë¥¼ ì‚¬ìš© í•˜ì˜€ë‹¤.

## 3. Pipeline flow

ì´ë²ˆ ELK êµ¬ì¶•í•˜ë©´ì„œ ì„¤ê³„í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì³ ì´ë‹¤.

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled%202.png)

- FileBeatë§Œ Logstashë¡œ ë³´ë‚¸ ì´ìœ ëŠ” ë¡œê·¸ ë“¤ì„ Indexingí•˜ê¸° ìœ„í•¨ì´ë‹¤. Indexing ë˜ì–´ì•¼ elasticsearchì—ì„œ ë¶„ì„ì„ í•  ë•Œ ê²€ìƒ‰ì´ë‚˜ í•„í„°ë§ì´ ìš©ì´í•˜ë‹¤. Metricì •ë³´ë“¤ì€ Indexingí•  í•„ìš”ê°€ ì—†ìœ¼ë‹ˆ ë°”ë¡œ elasticsearchë¡œ ì „ì†¡.
- KibanaëŠ” ë‹¨ì§€ ì‹œê°í™” ìš©ë„ ì´ë©°(ë¸Œë¼ìš°ì €ì— kibanaí¬íŠ¸ë¡œ ì ‘ê·¼) ë¶„ì„ì´ë‚˜ í†µê³„ ê²€ìƒ‰ ë“± ëª¨ë‘ ë’·ë‹¨ì¸ elasticsearchì—ì„œ ì‹¤í–‰ëœë‹¤

## 4. File structure

- **File tree structure**

```
ğŸ“¦docker-compose.yml
ğŸ“¦elasticsearch
 â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“œelasticsearch.yml
 â”£ ğŸ“œ.dockerignore
 â”— ğŸ“œDockerfile
ğŸ“¦logstash
 â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“œlogstash.yml
 â”£ ğŸ“‚pipeline
 â”ƒ â”— ğŸ“œlogstash.conf
 â”£ ğŸ“œ.dockerignore
 â”— ğŸ“œDockerfile
ğŸ“¦kibana
 â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“œkibana.yml
 â”£ ğŸ“œ.dockerignore
 â”— ğŸ“œDockerfi
ğŸ“¦metricbeat
 â”— ğŸ“œmetricbeat.yml
ğŸ“¦filebeat
 â”£ ğŸ“‚config
 â”ƒ â”— ğŸ“œfilebeat.yml
 â”£ ğŸ“‚data
 â”ƒ â”— ğŸ“œmeta.json
 â”— ğŸ“œDockerfile
```

- **docker-compose.yml**

```yaml
version: '3.7'

services:
  setup:
    profiles:
      - setup
    build:
      context: setup/
      args:
        ELASTIC_VERSION: ${ELASTIC_VERSION}
    init: true
    volumes:
      - ./setup/entrypoint.sh:/entrypoint.sh:ro,Z
      - ./setup/lib.sh:/lib.sh:ro,Z
      - ./setup/roles:/roles:ro,Z
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-}
      LOGSTASH_INTERNAL_PASSWORD: ${LOGSTASH_INTERNAL_PASSWORD:-}
      KIBANA_SYSTEM_PASSWORD: ${KIBANA_SYSTEM_PASSWORD:-}
      METRICBEAT_INTERNAL_PASSWORD: ${METRICBEAT_INTERNAL_PASSWORD:-}
      FILEBEAT_INTERNAL_PASSWORD: ${FILEBEAT_INTERNAL_PASSWORD:-}
      HEARTBEAT_INTERNAL_PASSWORD: ${HEARTBEAT_INTERNAL_PASSWORD:-}
      MONITORING_INTERNAL_PASSWORD: ${MONITORING_INTERNAL_PASSWORD:-}
      BEATS_SYSTEM_PASSWORD: ${BEATS_SYSTEM_PASSWORD:-}
    networks:
      - elk
    depends_on:
      - elasticsearch

  elasticsearch:
    build:
      context: elasticsearch/
      args:
        ELASTIC_VERSION: ${ELASTIC_VERSION}
    volumes:
      - /home/dongjin/Projects/elk/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro,Z
      - elasticsearch-vol:/usr/share/elasticsearch/data:Z
    ports:
      - 9200:9200
      - 9300:9300
    environment:
      node.name: elasticsearch
      ES_JAVA_OPTS: -Xms512m -Xmx512m
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-}
      discovery.type: single-node
    networks:
      - elk

  logstash:
    build:
      context: logstash/
      args:
        ELASTIC_VERSION: ${ELASTIC_VERSION}
    volumes:
      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro,Z
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro,Z
    ports:
      - 5044:5044
      - 50000:50000/tcp
      - 50000:50000/udp
      - 9600:9600
    environment:
      LS_JAVA_OPTS: -Xms256m -Xmx256m
      LOGSTASH_INTERNAL_PASSWORD: ${ELASTIC_PASSWORD:-}
    networks:
      - elk
    depends_on:
      - elasticsearch

  kibana:
    build:
      context: kibana/
      args:
        ELASTIC_VERSION: ${ELASTIC_VERSION}
    volumes:
      - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro,Z
    ports:
      - 5601:5601
    environment:
      KIBANA_SYSTEM_PASSWORD: ${KIBANA_SYSTEM_PASSWORD:-}
    networks:
      - elk
    depends_on:
      - elasticsearch

  metricbeat:
    image: docker.elastic.co/beats/metricbeat:7.6.2
    #user: root:root
    volumes:
            #- ./metricbeat/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ELASTICSEARCH_HOSTS=elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
      - KIBANA_HOST=kibana:5601
    networks:
      - elk

  filebeat:
    build:
      context: ./filebeat
    user: root:root
    container_name: filebeat
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-}
    volumes:
      - ./filebeat/data:/usr/share/filebeat/data
      - ./filebeat/config/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /var/log:/logs/host
      - /var/log:/usr/share/filebeat/logs
    networks:
      - elk

networks:
  elk:
    driver: bridge

volumes:
  elasticsearch-vol:
```

## 5. ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥

- Service Log Streaming

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled%203.png)

Observabilityíƒ­ì—ì„œ Streamë©”ë‰´ë¥¼ ì´ìš©í•˜ë©´ Service Logë“¤ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° ë°›ì•„ ë³¼ ìˆ˜ ìˆë‹¤. 

- Service Log Filter

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled%204.png)

Analyticsíƒ­ì—ì„œ discoverë©”ë‰´ë¥¼ ì´ìš©í•˜ë©´ indexë¥¼ ê³¨ë¼ í•„í„°ë§ì„ í•  ìˆ˜ ìˆë‹¤. ì‚¬ì§„ì€ í•´ë‹¹ ì¸ë±ì‹±ì˜ ë¡œê·¸ì—ì„œ contextë‚´ìš© ì¤‘ì— mcmot_01ì—ì„œ errorë¥¼ ê²€ìƒ‰í•œ ê²°ê³¼ì´ë‹¤. context ë§ê³  keyword, timestampë“± ë§ì€ ë‚´ìš©ë“¤ë¡œ í•„í„°ë§ í•  ìˆ˜ ìˆìœ¼ë©° ê° í•„í„°ë“¤ì„ or í˜¹ì€ andë¡œ ë§ë¶™ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- Metric ì •ë³´

![Untitled](%5BMonitoring%5D%20ELK%20aae850685eb44370943639786e885b42/Untitled%205.png)

Observabilityíƒ­ì—ì„œ Hostë©”ë‰´ë¥¼ ì´ìš©í•˜ë©´ í˜¸ìŠ¤íŠ¸ì˜ Metricì •ë³´ë“¤ì„ ë³¼ ìˆ˜ ìˆë‹¤. ì•„ë˜ Dashboardì— ì‹œê³„ì—´ ê·¸ë˜í”„ë¡œë„ í‘œí˜„ì´ ë˜ì–´ í•œ ëˆˆì— íŒŒì•…í•˜ê¸° ì‰½ë‹¤.

## TODO

- í˜„ì¬ Hostì˜ Metricì •ë³´ë§Œ ë°›ì•„ì˜¤ê³  ìˆì§€ë§Œ í–¥ í›„ì— Containerë³„ Metricì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ì–´ë–¤ ì„œë¹„ìŠ¤ì—ì„œ ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ì ìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸ í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•œë‹¤.
- í˜„ì¬ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ë¡œê·¸ë“¤ì„ í•œ Indexì— ë„£ì–´ì„œ ìˆ˜ì§‘í•˜ê³  ìˆì§€ë§Œ í–¥ í›„ì— ì„œë¹„ìŠ¤ë³„ ì¸ë±ì‹±ì„ í•˜ì—¬ ì¢€ ë” íš¨ê³¼ì ì¸ í•„í„°ë§ ë° ë¶„ì„ì„ í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•œë‹¤.
- Errorë° ì»¤ìŠ¤í„°ë§ˆì´ì§•í•œ ê°ì§€ ë£°ì„ í†µí•´ alertê¸°ëŠ¥ ë° ì—ëŸ¬ ëŒ€ì‘ ê¸°ëŠ¥ ê¹Œì§€ í¬í•¨ í•´ì•¼ ë¹„ë¡œì¨ ìë™í™” ëª¨ë‹ˆí„°ë§ì´ë¼ê³  í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤ (í•´ë‹¹ ê¸°ëŠ¥ë“¤ì€ ìœ ë£Œ ê¸°ëŠ¥ì„)